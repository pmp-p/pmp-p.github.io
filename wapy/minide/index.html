<!doctype html>
<title>wapy.js</title>

<base href="..">

<link rel="stylesheet" href="minide/minide.css">


<!-- MDI windowing -->
<link rel="stylesheet" href="minide/mdi/mdi.css">

    <!-- floating browser -->
    <script defer src="minide/mdi/browser/browser.js"></script>

    <!-- floating xterminal -->
    <script defer src="minide/mdi/vt/vt.js"></script>




<!-- // the python core either wapy or cpython -->
<script src="lib/pythons.003.js"></script>

<!-- // the js link part beetween js engine main loop and python main loop -->
<script src="lib/plink.003.js"></script>

<script defer src="lib/pyterm.js"></script>


<head>

</head>



<body>
<h1>Python3.x (wasm)</h1>
<br/>


<!-- EDITOR ZONE -->
<form method="post">
    <textarea id="editor" name="content" cols="132" rows="35"></textarea>
</form>

<div id=mdi_vt class=mdi>
    <!-- <button class="btn_popup">popup</button> -->
    <div class="anchor" >...</div>
    <div class="popup">
        <div class="handle">vt100<span class="close" style="float:right;cursor:pointer;padding-right:6px;"[X]</span></div>

    </div>
</div>






<div id=mdi_browser class=mdi>

    <div class="anchor" >...</div>
    <div class="popup">
        <div class="handle">http/80<span class="close" style="float:right;cursor:pointer;padding-right:6px;"[X]</span></div>



            <iframe sandbox='allow-pointer-lock allow-scripts allow-same-origin allow-modals'
                frameBorder='1' name="browser" id="browser" src=""
                width="795px" height="450px"
                seamless='seamless'
                ALLOWTRANSPARENCY='true'>
            </iframe>
    </div>
</div>


<div id="aio_fd_0"></div>
<canvas id="canvas" width="240" height="320" oncontextmenu="event.preventDefault()" tabindex="-1" style="border=1px;position:absolute;right:64px;top:64px"></canvas>


<div id="help" style="position:absolute;left:0;bottom:0">
  <p>Click the title bars and hold to drag windows. Click [save] icon to run program</p>
   <!-- <p>Double-click titlebar to maximize. Click the lower-right corner to resize.</p>
 <p>Click the tilde to open a new tab. Click with a modifier (ctrl/alt/option) to close the window.</p> -->
</div>


<pre id="log" style="position:absolute;left:0;bottom:200px">...</pre>


</body>

<!--
<script src="socket.io/socket.io.js"></script>
<script src="term.js"></script>
<script src="options.js"></script>
<script src="tty.js"></script>
-->

<!-- EMPYTHON INTERFACE -->
<!--
<script type='text/javascript' src="./pp/btoa_utf8.js"></script>
<script type='text/javascript' src="./pp/tools.js"></script>
<script type='text/javascript' src="./pp/fd.js"></script>
-->
<!-- -->



<script type='text/python'>
import embed
# allow hardware(js) interrupts while in python virtual machine

embed.STI()

def aio_suspend():
    import syscall

class aio:
    suspend =aio_suspend


</script>

<script type='text/javascript'>
    window.repl = 1
    window.stock = false

    function PYTHONSTARTUP(){
        console.log("PYTHONSTARTUP")
    }

    // ============================== FILE I/O (sync => bad) =================================
    include("lib/file_api_002.js")

    // ================= web->sockets (async, may work) ===============================
    include("lib/socket_api_002.js")


    // cors handling thanks to https://github.com/Rob--W/cors-anywhere https://robwu.nl/cors-anywhere.html
    if ( undef("CORS_BROKER") ){
        window.CORS_BROKER = "https://cors-anywhere.herokuapp.com/"
        console.log("Using default brooker CORS_BROKER="+CORS_BROKER)
    }
</script>




<script type='text/javascript'>


async function str(o){
    return ""+ await o.__str__()
}

//register(str)

async function int(o){
    return 0+await o.__int__()
}
//register(int)

// await py.sys.version.__str__() await str(py.sys.modules)

    var callpath = []
    var callid = 0
    var keep_alive =  new Blob(["#e30=\r\n"])  // #{}\r\n

    let rpc_handler = {
        get(self, name) {
            if (!callpath)
                callpath = []

            if (name == "__hardref__") {
                console.log("hardref N/I")
            /* TODO
                var c = {}
                var cid = ++callid
                    c["id"] = cid
                    c["g"] = callpath.join(".")
                    c["a"] = name
                while (callpath.length) callpath.pop()
                ws.send( new Blob(["#"+btoaUTF8(JSON.stringify(c))+"\r\n"]) )

                return async function wait_reply(){
                    console.log('GET '+c['g']+'.__ref__' )
                    return c['g']+'.__ref__'
                }
                */
            } else {
                callpath.push(name)
                return callrpc
            }

        }
    }

    async function RPC_CallPath(){
        var c = {}
        var cid = ++callid
            c["id"] = cid
            c["m"] = callpath.join(".")
            c["a"] = Array.from(arguments)
        while (callpath.length) callpath.pop()
        ws.send( new Blob(["#"+btoaUTF8(JSON.stringify(c))+"\r\n"]) )



        await _until(has_key)(window.embed_replies, cid)

        result = window.embed_replies.get(cid)
        window.embed_replies.delete( cid )
        //console.log("found reply "+ result )
        return result
    }


    var callrpc =  new Proxy( RPC_CallPath, rpc_handler )
    window.py = callrpc


    function clog(msg) {
        document.getElementById('log').textContent += msg + '\n';
    }



    function pump(){
        console.log("pump" + ws );
        ws.send( keep_alive );
    }

if(0){
    // setup websocket with callbacks
    var ws = new WebSocket('ws://localhost:40080/', 'binary');

    ws.binaryType = "blob";   // or 'arrayBuffer'

    ws.onopen = function() {
        log('CONNECT');
    };

    ws.onclose = function() { log('DISCONNECT'); };


    ws.onmessage = function(e) {
        if (   embed_process_msg( blob_as_str(e.data) ) )
            setTimeout( pump, 1000)
    }

}
    function main(){
        //var cs = new socket('AF_LOCAL','SOCK_STREAM', 'http');
          //  cs.connect('localhost:80')

    }

// <!--

    window.onload = function() {
        window.state = {};
        //setTimeout(window.main, 3000);
        //setTimeout(browse,3000);
    }


// -->
</script>






<script src="edit_area/edit_area_full.js" type="text/javascript" language="javascript"></script>

<script>

function editAreaLoaded(id){
    if(id=="editor")
    {
        var new_file= {
            id: "file1",
            text: `# Click [save] toolbar's icon to run program
# Cliquer la disquette dans la barre d'outil pour executer

def test():
    x=999
    while x:
        aio.suspend()
        print('{:0>4}: Hello #python-fr'.format(x))
        x -= 1

test()


`         , syntax: 'python'
            , title: 'noname.py'
        };
        editAreaLoader.openFile( id , new_file);
        setTimeout(function(){



    var frame_editor = document.querySelector("#frame_editor")
    frame_editor.style.position = "absolute"
    frame_editor.style.left=0
}
, 900);
    }

}
window.editAreaLoaded = editAreaLoaded

function save_callback(eal_id, data) {
    clog("save_callback "+eal_id +" " +data.length )
    term.reset() //PyRun_SimpleString('embed.context_switch()')
    PyRun_SimpleString(data)

}
window.save_callback = save_callback

function change_callback(eal_id) {
    console.log("change_callback "+eal_id )

}
window.change_callback = change_callback

editAreaLoader.init({
    id : "editor"		// textarea id
    ,syntax: "python"			// syntax to be uses for highgliting
    ,start_highlight: true		// to display with highlight mode on start-up
    ,is_multi_files: true
    ,show_line_colors: true // hi cpu
    ,allow_resize: "no"
    ,allow_toggle: false
    ,language : "fr"
    ,display : "onload"
    ,cursor_position: "auto"
    ,replace_tab_by_spaces : 4
    ,EA_load_callback: "editAreaLoaded"
    ,save_callback : "save_callback"
    ,change_callback: "change_callback"
    ,begin_toolbar : "new_document, load, save"
    ,toolbar : "separator, search, go_to_line, fullscreen, |, undo, redo, |, select_font,|, change_smooth_selection, highlight, reset_highlight, word_wrap"
    ,end_toolbar : "separator, help"
});
</script>


