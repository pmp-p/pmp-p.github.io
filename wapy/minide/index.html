<!doctype html><script type='text/python'>import embed
# TODO: https://github.com/mrdoob/stats.js/
# zoom : https://codepen.io/skladany/pen/KrjRQE
import sys

def aio_suspend():
    import syscall

class aio:
    suspend =aio_suspend


# allow hardware(js) interrupts while in python virtual machine
embed.STI()


</script>
<script>
default_code=`# Click [save] toolbar's icon to run program
# Cliquer la disquette dans la barre d'outil pour executer


def test():
    x=999
    while x:
        aio.suspend()
        print('{:0>4}: Hello #python-fr'.format(x))
        x -= 1

def ffi_test():
    lib = ffi.open('/lib/libtest.so')
    return lib.func("v","init_test","")

def ptr_test():
    renderer = static(SDL_Renderer)
    print(SDL_Renderer)
    print(renderer)

    rd = embed.sdl(renderer)

    print(SDL_Renderer)
    print(renderer)
    print(rd)

def init_sdl():
    global renderer, window
    import ctypes
    import usdl2 as sdl2
    e = SDL_Init(SDL_INIT_VIDEO)
    if not e:
        if 1:
            renderer = ctypes.PT('SDL_Renderer')
            window = ctypes.PT('SDL_Window')
            e = sdl2.SDL_CreateWindowAndRenderer(320,240,0,window.byref(),renderer.byref())
        else:
            window = sdl2.SDL_CreateWindow("Hello World", sdl2.SDL_WINDOWPOS_CENTERED, sdl2.SDL_WINDOWPOS_CENTERED, 640, 480, sdl2.SDL_WINDOW_SHOWN)

    else:
        print('SDL_Init error', e)



def sdl2_test():
    global window, renderer
    NULL = None




    init_sdl()


    print(renderer)
    renderer = int(renderer)
    print(renderer)


    SDL_SetRenderDrawColor(renderer, 255, 255, 255, SDL_ALPHA_OPAQUE);
    SDL_RenderDrawLine(renderer, 220, 100, 200, 140)
    SDL_RenderDrawLine(renderer, 200, 140, 240, 140)
    SDL_RenderDrawLine(renderer, 240, 140, 220, 100)


    if 1:
        bitmapSurface = SDL_LoadBMP(b"hello.bmp")

        print(bitmapSurface)

        bitmapTex = SDL_CreateTextureFromSurface(renderer, bitmapSurface);
        SDL_FreeSurface(bitmapSurface);
        SDL_RenderClear(renderer);
        SDL_RenderCopy(renderer, bitmapTex, NULL, NULL);

    SDL_RenderPresent(renderer)

def static(c_n):
    import ctypes
    return ctypes.PT(c_n)

def sdl2_fail():
    global running
    import usdl2 as sdl2
    from ctypes import PT

    def run():
        global running
        init_sdl()

        print("window:",window)

        fname = b'hello.bmp'

        image = sdl2.SDL_LoadBMP(fname)

        print("image:",image)

        windowsurface = sdl2.SDL_GetWindowSurface(window)


        sdl2.SDL_BlitSurface(image, None, windowsurface, None)


        #sdl2.SDL_UpdateWindowSurface(window.byref())


        sdl2.SDL_FreeSurface(image)

        running = True
        tick = 0

        event = PT( sdl2.SDL_Event )

        while running:
            while sdl2.SDL_PollEvent(event.byref()) != 0:
                if event.type == sdl2.SDL_QUIT:
                    running = False
                    break
                aio.suspend()
            #sdl2.SDL_Delay(16)

        print("running:",running)
        sdl2.SDL_DestroyWindow(window)
        sdl2.SDL_Quit()
        return 0

    run()

F=dir()
from usdl2 import *

print("\\n"*4)
print("SDL2 is now loaded, you can run some tests functions too")
print(F)


`



</script>



<title>wapy.js</title>

<base href="..">

<link rel="stylesheet" href="minide/minide.css">


<!-- MDI windowing -->
<link rel="stylesheet" href="minide/mdi/mdi.css">





<head>
    <meta charset="UTF-8">
</head>

<style>
* {
  box-sizing: border-box;
}

html, body {
  width: 100%;
  margin: 0;
  padding: 0;
}

body {
  margin: 0 auto;
  width: 1000px;
  transform-origin:top center;
}



header {
  width: 100%;
  background-color: pink;
}

/*
img {
  width: 100%;
}

div {
  float: left;
  width: 60%;
  background-color:green;
}

div+div {
  width: 40%;
  background-color: teal;
}

header h1, div h2 {
  padding: 12px;
}
*/

body {
    background-color: #646464;
    -ms-transform:scale(1); // Req for IE9
    transform:scale(1);

}

</style>

<body>

<h1>
<div align=left style="position: relative;bottom: 4px;top: -2px">
<img height=32 src="/wapy/logos/wa-80x80.png">
<img height=32 src="/wapy/logos/wapy-266x80.png">
<img height=32 src="/wapy/logos/650px-Python3-powered_hello-world.svg.png">
<img height=32 src="/wapy/logos/panda3d-374x80.png">
<img height=32 src="/wapy/logos/sdl2-136x80.png">
 - Python 3.x (wasm) : All code is running <b>inside</b> your browser -
</div>

</h1>




<!-- EDITOR ZONE -->
<form method="post">
    <textarea id="editor" name="content" cols="132" rows="51"></textarea>
</form>

<div id=mdi_vt class=mdi>
    <!-- <button class="btn_popup">popup</button> -->
    <div class="anchor" >...</div>
    <div class="popup">
        <div class="handle">vt100<span class="close" style="float:right;cursor:pointer;padding-right:6px;"[X]</span></div>

    </div>
</div>




<div id=mdi_browser class=mdi>

    <div class="anchor" >...</div>
    <div class="popup">
        <div class="handle">http/80<span class="close" style="float:right;cursor:pointer;padding-right:6px;"[X]</span></div>



            <iframe sandbox='allow-pointer-lock allow-scripts allow-same-origin allow-modals'
                frameBorder='1' name="browser" id="browser" src=""
                width="795px" height="450px"
                seamless='seamless'
                ALLOWTRANSPARENCY='true'>
            </iframe>
    </div>
</div>


<div id="aio_fd_0"></div>
<canvas id="canvas" width="320" height="240" oncontextmenu="event.preventDefault()" tabindex="-1" style="border=1px;position:absolute;right:28px;top:60px"></canvas>


<div id="help" style="position:absolute;bottom:0">
  <p>Click the title bars and hold to drag windows. Click [save] icon to run program. Wapy ©®™ is built only by and for week-end coders.</p>
   <!-- <p>Double-click titlebar to maximize. Click the lower-right corner to resize.</p>
 <p>Click the tilde to open a new tab. Click with a modifier (ctrl/alt/option) to close the window.</p> -->
</div>


<pre id="log" style="position:absolute;left:0;bottom:60px">...</pre>


</body>




<script type='text/javascript'>


async function str(o){
    return ""+ await o.__str__()
}

//register(str)

async function int(o){
    return 0+await o.__int__()
}
//register(int)

// await py.sys.version.__str__() await str(py.sys.modules)

    var callpath = []
    var callid = 0
    var keep_alive =  new Blob(["#e30=\r\n"])  // #{}\r\n

    let rpc_handler = {
        get(self, name) {
            if (!callpath)
                callpath = []

            if (name == "__hardref__") {
                console.log("hardref N/I")
            /* TODO
                var c = {}
                var cid = ++callid
                    c["id"] = cid
                    c["g"] = callpath.join(".")
                    c["a"] = name
                while (callpath.length) callpath.pop()
                ws.send( new Blob(["#"+btoaUTF8(JSON.stringify(c))+"\r\n"]) )

                return async function wait_reply(){
                    console.log('GET '+c['g']+'.__ref__' )
                    return c['g']+'.__ref__'
                }
                */
            } else {
                callpath.push(name)
                return callrpc
            }

        }
    }

    async function RPC_CallPath(){
        var c = {}
        var cid = ++callid
            c["id"] = cid
            c["m"] = callpath.join(".")
            c["a"] = Array.from(arguments)
        while (callpath.length) callpath.pop()
        ws.send( new Blob(["#"+btoaUTF8(JSON.stringify(c))+"\r\n"]) )



        await _until(has_key)(window.embed_replies, cid)

        result = window.embed_replies.get(cid)
        window.embed_replies.delete( cid )
        //console.log("found reply "+ result )
        return result
    }


    var callrpc =  new Proxy( RPC_CallPath, rpc_handler )
    window.py = callrpc


    function clog(msg) {
        document.getElementById('log').textContent += msg + '\n';
    }



    function pump(){
        console.log("pump" + ws );
        ws.send( keep_alive );
    }

if(0){
    // setup websocket with callbacks
    var ws = new WebSocket('ws://localhost:40080/', 'binary');

    ws.binaryType = "blob";   // or 'arrayBuffer'

    ws.onopen = function() {
        log('CONNECT');
    };

    ws.onclose = function() { log('DISCONNECT'); };


    ws.onmessage = function(e) {
        if (   embed_process_msg( blob_as_str(e.data) ) )
            setTimeout( pump, 1000)
    }

}
    function main(){
        //var cs = new socket('AF_LOCAL','SOCK_STREAM', 'http');
          //  cs.connect('localhost:80')

    }

// <!--

    window.onload = function() {
        window.state = {};
        //setTimeout(window.main, 3000);
        //setTimeout(browse,3000);
    }


// -->
</script>


<!-- // the js link part beetween js engine main loop and python main loop -->
<script src="lib/plink.003.js"></script>


<!-- // the python core either wapy or cpython -->
<script  src="lib/pythons.003.js"></script>


<script src="lib/pyterm.js"></script>


<script src="edit_area/edit_area_full.js" type="text/javascript" language="javascript"></script>

<script>


window.repl = 1
window.stock = false

function PYTHONSTARTUP(){
    console.log("PYTHONSTARTUP")
//    <!-- floating browser -->
    include("minide/mdi/browser/browser.js")

//    <!-- floating xterminal -->
    include("minide/mdi/vt/vt.js")

}

// ============================== FILE I/O (sync => bad) =================================
include("lib/file_api_002.js")

// ================= web->sockets (async, may work) ===============================
include("lib/socket_api_002.js")


// cors handling thanks to https://github.com/Rob--W/cors-anywhere https://robwu.nl/cors-anywhere.html
if ( undef("CORS_BROKER") ){
    window.CORS_BROKER = "https://cors-anywhere.herokuapp.com/"
    console.log("Using default brooker CORS_BROKER="+CORS_BROKER)
}


function editAreaLoaded(id){
    if(id=="editor")
    {
        var new_file= {
            id: "file1"
            , text: default_code
            , syntax: 'python'
            , title: '__main__.py'
        };
        editAreaLoader.openFile( id , new_file);
        setTimeout(
            function(){
                var frame_editor = document.querySelector("#frame_editor")
                frame_editor.style.position = "absolute"
                frame_editor.style.left=0
            }
            , 900);
    }

}
window.editAreaLoaded = editAreaLoaded

function save_callback(eal_id, data) {
    clog("save_callback "+eal_id +" " +data.length )
    term.reset() //PyRun_SimpleString('embed.context_switch()')
    PyRun_SimpleString(data)

}
window.save_callback = save_callback

function change_callback(eal_id) {
    console.log("change_callback "+eal_id )

}
window.change_callback = change_callback

editAreaLoader.init({
    id : "editor"		// textarea id
    ,syntax: "python"			// syntax to be uses for highgliting
    ,start_highlight: true		// to display with highlight mode on start-up
    ,is_multi_files: true
    ,show_line_colors: true // hi cpu
    ,allow_resize: "no"
    ,allow_toggle: false
    ,language : "fr"
    ,display : "onload"
    ,cursor_position: "auto"
    ,replace_tab_by_spaces : 4
    ,EA_load_callback: "editAreaLoaded"
    ,save_callback : "save_callback"
    ,change_callback: "change_callback"
    ,begin_toolbar : "new_document, load, save"
    ,toolbar : "separator, search, go_to_line, fullscreen, |, undo, redo, |, select_font,|, change_smooth_selection, highlight, reset_highlight, word_wrap"
    ,end_toolbar : "separator, help"
});
</script>



