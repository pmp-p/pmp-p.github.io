<!doctype html><script type='text/python'>import embed
# TODO: https://github.com/mrdoob/stats.js/
# zoom : https://codepen.io/skladany/pen/KrjRQE

import sys
import builtins
import ctypes

def static(c_n):
    return ctypes.PT(c_n)

import utime as Time

import python3


# allow hardware(js) interrupts while in python virtual machine
def VMIF(sti, verbose=0):
    if sti:embed.STI()
    else:embed.CLI()
    if verbose:
        if not embed.FLAGS_IF():
            print("Warning : hardware interrupt disabled, using micropython VM")
        else:
            print("Warning : hardware interrupt enabled, using WAPY VM")
        print("\n❯❯❯ ",end='')

def STI(verbose=0):
    VMIF(True,verbose)

def CLI(verbose=0):
    VMIF(False,verbose)

STI(1)


</script>

<style>
.python {
    // no effect
    type : "text/plain";
}

</style>

<script id="sockserv.py" class=file  type="text/plain">

import io
import binascii

import plink
from plink import window,CallPath


class socket:
    def __init__(self):
        self.i = io.BytesIO()
        self.o = io.BytesIO()
        self.sid = "?"

    @classmethod
    def getaddrinfo(cls, host, port):
        return [ [(host,port,)] ]

    async def connect(self, addr):
        window.embed_dbg = 1
        plink.DBG=1
        self.sid = await window.socks.open(*addr)
        try:
            await aio.io.ctl(self, 'open',tmout=3000)
        except Exception as e:
            print("SOCKET:",self,"TMOUT",e)

    def makefile(self):pass

    def write(self,b):
        CallPath.proxy.io( self.sid ,m="N", jscmd=b )


    def __repr__(self):
        return f"<socket {self.sid}>"


async def __main__(argc, argv):
    print(" ------------- Hello WasmPython + sockets ----------")

    (HOST,PORT) = ('pmpp.ddns.net', 26667)
    print(f'connecting to {HOST}:{PORT}')

    sock = socket()
    await sock.connect( (HOST,PORT,) )
    sock.write(b"CAP LS\nNICK wapy\nUSER wapy wapy locahost :wsocket\nJOIN #sav\n")


</script>

<script id="bugs.py" class=file type="text/plain">
#CLI()

def rgb_test0(r,g,b):
    print(r)
    print(g)
    print(b)

#BUG local of *argv names get lost
def rgb_test(r=255,g=255,b=255):
    print(r)
    print(g)
    print(b)



print("\n","="*60)

rgb_test0(0,0,255)

rgb_test()

aio.suspend()


#===============================================

import pystone1
pystone1.__main__()
</script>

<script id="__main__.py" class=file type="text/plain">

def blockio_test():
    x=999
    while x:
        aio.suspend()
        print('{:0>4}: Hello #python-fr'.format(x))
        x -= 1

def ffi_test():
    import ffi
    lib = ffi.open('/lib/libtest.so')
    return lib.func("v","init_test","")

embed.os_hideloop()
blockio_test()

print()
embed.os_showloop()
aio_suspend()
ffi_test()()

</script>

<script id="upysdl2.py" class=file type="text/plain">

#BUG pystack/locals def draw_triangle(r=255,g=255,b=255) : workaround no INT path.
#BUG SDL_UpdateWindowSurface()


renderer = None
window = None


def draw_triangle(r=128,g=128,b=128):
    global renderer
    SDL_SetRenderDrawColor(renderer, r, g, b, SDL_ALPHA_OPAQUE)
    SDL_RenderDrawLine(renderer, 220, 100, 200, 140)
    SDL_RenderDrawLine(renderer, 200, 140, 240, 140)
    SDL_RenderDrawLine(renderer, 240, 140, 220, 100)

def init_sdl():
    global renderer, window
    import ctypes
    import usdl2 as sdl2
    e = SDL_Init(SDL_INIT_VIDEO)
    if not e:
        if 1:
            renderer = static(SDL_Renderer)
            window = static(SDL_Window)
            e = sdl2.SDL_CreateWindowAndRenderer(320,240,0, window.byref(), renderer.byref())
        else:
            window = sdl2.SDL_CreateWindow("Hello World", sdl2.SDL_WINDOWPOS_UNDEFINED, sdl2.SDL_WINDOWPOS_UNDEFINED, 640, 480, sdl2.SDL_WINDOW_SHOWN)

        # TODO: unpack the new ptr automatically
        int(renderer)
        int(window)
    else:
        print('SDL_Init error', e)

    return window, renderer,


def sdl2_test():
    global window, renderer, running, ev, evref

    init_sdl()

    bitmapSurface = SDL_LoadBMP(b"hello.bmp")
    print("bitmap",bitmapSurface)

    if 0:
        windowsurface = SDL_GetWindowSurface(window)
        print("windowsurface=",windowsurface)
        SDL_BlitSurface(bitmapSurface, None, windowsurface, None)
        #BUG
        SDL_UpdateWindowSurface(window)
    else:
        bitmapTex = SDL_CreateTextureFromSurface(renderer, bitmapSurface);
        SDL_FreeSurface(bitmapSurface);
        SDL_RenderClear(renderer);
        SDL_RenderCopy(renderer, bitmapTex, None, None);


    # a blue triangle
    draw_triangle(0,0,255)


    last = 0

    running = True

    ev = static( SDL_Event )
    evref = ev.byref()

    countdown = 15
    tictac = python3.Lapse(1)

    embed.os_hideloop()

    while running:
        aio.suspend()

        if tictac:
            countdown -=1
            if not countdown:
                print("tmout!")
                running = False

        elif SDL_PollEvent(evref) != 0:
            if ev.type == SDL_QUIT:
                running = False
                break
            if ev.type != last:
                print(countdown, "ev.type =", ev.type)
                last = ev.type
        SDL_RenderPresent(renderer)


    embed.os_showloop()
    if 0:
        SDL_DestroyWindow(window)
        SDL_Quit()


def sdl2_ok():
    global window, renderer
    init_sdl()

    bitmapSurface = SDL_LoadBMP(b"hello.bmp")
    print("bitmap=",bitmapSurface)

    bitmapTex = SDL_CreateTextureFromSurface(renderer, bitmapSurface);
    SDL_FreeSurface(bitmapSurface);
    SDL_RenderClear(renderer);
    SDL_RenderCopy(renderer, bitmapTex, None, None);

    draw_triangle(0,0,255)
    SDL_RenderPresent(renderer)

CLI()
F=dir()
from usdl2 import *
builtins.SDL_Renderer = SDL_Renderer
print( "SDL_Renderer", SDL_Renderer , "=", renderer)
STI()


print("\n"*4)
print("SDL2 is now loaded, you can run some tests functions like :")
for f in F:
    if str(f).count('sdl2'):
        print(' -',f)

aio_suspend()

sdl2_test()

aio_suspend()

</script>




<title>wapy.js</title>

<base href="..">

<link rel="stylesheet" href="minide/minide.css">


<!-- MDI windowing -->
<link rel="stylesheet" href="minide/mdi/mdi.css">





<head>
    <meta charset="UTF-8">
</head>

<style>
* {
  box-sizing: border-box;
}

html, body {
  width: 100%;
  margin: 0;
  padding: 0;
}

body {
  margin: 0 auto;
  width: 1000px;
  transform-origin:top center;
}



header {
  width: 100%;
  background-color: pink;
}

/*
img {
  width: 100%;
}

div {
  float: left;
  width: 60%;
  background-color:green;
}

div+div {
  width: 40%;
  background-color: teal;
}

header h1, div h2 {
  padding: 12px;
}
*/

body {
    background-color: #646464;
    -ms-transform:scale(1); // Req for IE9
    transform:scale(1);

}

</style>

<body>

<h1>
<div align=left style="position: relative;bottom: 4px;top: -2px">
<img height=32 src="/wapy/logos/wa-80x80.png">
<img height=32 src="/wapy/logos/wapy-266x80.png">
<img height=32 src="/wapy/logos/650px-Python3-powered_hello-world.svg.png">
<img height=32 src="/wapy/logos/panda3d-374x80.png">
<img height=32 src="/wapy/logos/sdl2-136x80.png">
 - Python 3.x (wasm) : All code is running <b>inside</b> your browser -
</div>

</h1>




<!-- EDITOR ZONE -->
<form method="post">
    <textarea id="editor" name="content" cols="132" rows="51"></textarea>
</form>

<div id=mdi_vt class=mdi>
    <!-- <button class="btn_popup">popup</button> -->
    <div class="anchor" >...</div>
    <div class="popup">
        <div class="handle">vt100<span class="close" style="float:right;cursor:pointer;padding-right:6px;"[X]</span></div>

    </div>
</div>




<div id=mdi_browser class=mdi>

    <div class="anchor" >...</div>
    <div class="popup">
        <div class="handle">http/80<span class="close" style="float:right;cursor:pointer;padding-right:6px;"[X]</span></div>



            <iframe sandbox='allow-pointer-lock allow-scripts allow-same-origin allow-modals'
                frameBorder='1' name="browser" id="browser" src=""
                width="795px" height="450px"
                seamless='seamless'
                ALLOWTRANSPARENCY='true'>
            </iframe>
    </div>
</div>


<div id="aio_fd_0"></div>
<canvas id="canvas" width="320" height="240" oncontextmenu="event.preventDefault()" tabindex="-1" style="border=1px;position:absolute;right:28px;top:60px"></canvas>


<div id="help" style="position:absolute;bottom:0">
  <p>Click and hold title bars to drag windows. Click [save] icon to run program. Wapy ©®™ is built only by and for week-end coders.</p>
   <!-- <p>Double-click titlebar to maximize. Click the lower-right corner to resize.</p>
 <p>Click the tilde to open a new tab. Click with a modifier (ctrl/alt/option) to close the window.</p> -->
</div>


<pre id="log" style="position:absolute;left:0;bottom:60px">...</pre>


</body>




<script type='text/javascript'>


async function str(o){
    return ""+ await o.__str__()
}

//register(str)

async function int(o){
    return 0+await o.__int__()
}
//register(int)

// await py.sys.version.__str__() await str(py.sys.modules)

    var callpath = []
    var callid = 0
    var keep_alive =  new Blob(["#e30=\r\n"])  // #{}\r\n

    let rpc_handler = {
        get(self, name) {
            if (!callpath)
                callpath = []

            if (name == "__hardref__") {
                console.log("hardref N/I")
            /* TODO
                var c = {}
                var cid = ++callid
                    c["id"] = cid
                    c["g"] = callpath.join(".")
                    c["a"] = name
                while (callpath.length) callpath.pop()
                ws.send( new Blob(["#"+btoaUTF8(JSON.stringify(c))+"\r\n"]) )

                return async function wait_reply(){
                    console.log('GET '+c['g']+'.__ref__' )
                    return c['g']+'.__ref__'
                }
                */
            } else {
                callpath.push(name)
                return callrpc
            }

        }
    }

    async function RPC_CallPath(){
        var c = {}
        var cid = ++callid
            c["id"] = cid
            c["m"] = callpath.join(".")
            c["a"] = Array.from(arguments)
        while (callpath.length) callpath.pop()
        ws.send( new Blob(["#"+btoaUTF8(JSON.stringify(c))+"\r\n"]) )



        await _until(has_key)(window.embed_replies, cid)

        result = window.embed_replies.get(cid)
        window.embed_replies.delete( cid )
        //console.log("found reply "+ result )
        return result
    }


    var callrpc =  new Proxy( RPC_CallPath, rpc_handler )
    window.py = callrpc


    function clog(msg) {
        document.getElementById('log').textContent += msg + '\n';
    }



    function pump(){
        console.log("pump" + ws );
        ws.send( keep_alive );
    }

if(0){
    // setup websocket with callbacks
    var ws = new WebSocket('ws://localhost:40080/', 'binary');

    ws.binaryType = "blob";   // or 'arrayBuffer'

    ws.onopen = function() {
        log('CONNECT');
    };

    ws.onclose = function() { log('DISCONNECT'); };


    ws.onmessage = function(e) {
        if (   embed_process_msg( blob_as_str(e.data) ) )
            setTimeout( pump, 1000)
    }

}
    function main(){
        //var cs = new socket('AF_LOCAL','SOCK_STREAM', 'http');
          //  cs.connect('localhost:80')

    }

// <!--

    window.onload = function() {
        window.state = {};
    }


// -->
</script>


<!-- // the js link part beetween js engine main loop and python main loop -->
<script src="lib/plink.003.js"></script>


<!-- // the python core either wapy or cpython -->
<script  src="lib/pythons.003.js"></script>


<script src="wapy-lib.js"></script>

<script src="lib/pyterm.js"></script>


<script src="edit_area/edit_area_full.js" type="text/javascript" language="javascript"></script>

<script>


window.repl = 1
window.stock = false

function PYTHONSTARTUP(){
    console.log("PYTHONSTARTUP")
//    <!-- floating browser -->
    include("minide/mdi/browser/browser.js")

//    <!-- floating xterminal -->
    include("minide/mdi/vt/vt.js")

}

// ============================== FILE I/O (sync => bad) =================================
include("lib/file_api_002.js")

// ================= web->sockets (async, may work) ===============================
include("lib/socket_api_002.js")


// cors handling thanks to https://github.com/Rob--W/cors-anywhere https://robwu.nl/cors-anywhere.html
if ( undef("CORS_BROKER") ){
    window.CORS_BROKER = "https://cors-anywhere.herokuapp.com/"
    console.log("Using default brooker CORS_BROKER="+CORS_BROKER)
}


function editAreaLoaded(id){
    if(id=="editor")
    {
        var fileid = 1;

        function new_script(fname) {
            return {
                id: "file" + fileid++
                , text: `# Click [save] toolbar's icon to run program
# Cliquer la disquette dans la barre d'outil pour executer` + window[fname ].text
                , syntax: 'python'
                , title: fname
            }
        }

        var scripts = document.getElementsByTagName('script')

        for(var i = 0; i < scripts.length; i++){
            var script = scripts[i]
            if(script.className == 'file'){
                editAreaLoader.openFile( id , new_script(script.id))
            }
        }

        setTimeout(
            function(){
                var frame_editor = document.querySelector("#frame_editor")
                frame_editor.style.position = "absolute"
                frame_editor.style.left=0
            }
            , 850);
    }

}
window.editAreaLoaded = editAreaLoaded

function save_callback(eal_id, data) {
    clog("save_callback "+eal_id +" " +data.length )
    term.reset() //PyRun_SimpleString('embed.context_switch()')
    PyRun_SimpleString(data)

}
window.save_callback = save_callback

function change_callback(eal_id) {
    console.log("change_callback "+eal_id )

}
window.change_callback = change_callback

editAreaLoader.init({
    id : "editor"		// textarea id
    ,syntax: "python"			// syntax to be uses for highgliting
    ,start_highlight: true		// to display with highlight mode on start-up
    ,is_multi_files: true
    ,show_line_colors: true // hi cpu
    ,allow_resize: "no"
    ,allow_toggle: false
    ,language : "fr"
    ,display : "onload"
    ,cursor_position: "auto"
    ,replace_tab_by_spaces : 4
    ,EA_load_callback: "editAreaLoaded"
    ,save_callback : "save_callback"
    ,change_callback: "change_callback"
    ,begin_toolbar : "save" //, new_document, load, save"
    ,toolbar : "separator, search, go_to_line, fullscreen, |, undo, redo, |, select_font,|, change_smooth_selection, highlight, reset_highlight, word_wrap"
    ,end_toolbar : "separator, help"
});
</script>



